---

- hosts: all
  tasks:

    - name: Private portal
      kubernetes.core.helm:
        name: homer
        chart_ref: k8s-at-home/homer
        release_namespace: homer
        create_namespace: true
        values:
          configmap:
            config:
              enabled: true
              data:
                config.yml: "{{ lookup('template', 'app/homer.yml') }}"
          ingress:
            main:
              enabled: true
              annotations:
                traefik.ingress.kubernetes.io/router.entrypoints: web
              hosts:
                - host: "sillykube"
                  paths:
                    - path: "/"
                      pathType: Prefix
      tags:
        - private


    - name: Public portal
      kubernetes.core.helm:
        name: homer
        chart_ref: k8s-at-home/homer
        release_namespace: homer-public
        create_namespace: true
        values:
          configmap:
            config:
              enabled: true
              data:
                config.yml: "{{ lookup('template', 'app/homer_public.yml') }}"
          ingress:
            main:
              enabled: true
              annotations:
                traefik.ingress.kubernetes.io/router.entrypoints: websecure
              hosts:
                - host: "paulin.homes"
                  paths:
                    - path: "/"
                      pathType: Prefix
      tags:
        - public

    - name: Homer route
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.containo.us/v1alpha1
          kind: IngressRoute
          metadata:
            name: homer
            namespace: homer-public
          spec:
            entryPoints:
              - websecure
            routes:
              - match: PathPrefix(`/`)
                kind: Rule
                services:
                  - name: homer
                    port: 8080
